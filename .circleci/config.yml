version: 2.1

orbs:
  win: circleci/windows@5.0

jobs:
  build-windows-msvc:
    executor:
      name: win/default
      size: large
      shell: powershell.exe
    
    environment:
      VCPKG_ROOT: C:\vcpkg
      VCPKG_DEFAULT_TRIPLET: x86-windows
    
    steps:
      - checkout
      
      # Восстанавливаем кэш vcpkg для ускорения сборки
      - restore_cache:
          name: Restore vcpkg cache
          keys:
            - vcpkg-{{ arch }}-{{ checksum "vcpkg.json" }}-v1
            - vcpkg-{{ arch }}-v1
      
      - run:
          name: Setup vcpkg
          command: |
            if (-Not (Test-Path $env:VCPKG_ROOT)) {
              Write-Host "Cloning vcpkg..."
              git clone https://github.com/Microsoft/vcpkg.git $env:VCPKG_ROOT
              & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
            } else {
              Write-Host "vcpkg already exists, updating..."
              cd $env:VCPKG_ROOT
              git pull
            }
      
      - run:
          name: Install dependencies (zlib & boost)
          command: |
            & "$env:VCPKG_ROOT\vcpkg.exe" install `
              zlib `
              boost-iostreams `
              boost-system `
              boost-filesystem `
              boost-program-options
      
      # Сохраняем кэш для будущих сборок
      - save_cache:
          name: Save vcpkg cache
          key: vcpkg-{{ arch }}-{{ checksum "vcpkg.json" }}-v1
          paths:
            - C:\vcpkg\installed
            - C:\vcpkg\downloads
      
      - run:
          name: Configure with CMake
          command: |
            New-Item -ItemType Directory -Force -Path build
            cd build
            cmake -G "Visual Studio 17 2022" -A x86 `
                  -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
                  -DCMAKE_BUILD_TYPE=Release `
                  ..
      
      - run:
          name: Build project
          command: |
            cd build
            cmake --build . --config Release --parallel 4
      
      - run:
          name: Run tests
          command: |
            cd build
            ctest -C Release --output-on-failure
      
      - store_artifacts:
          path: build\Release\v8parser.exe
          destination: windows-binary

workflows:
  build:
    jobs:
      - build-windows-msvc
